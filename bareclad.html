<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Bareclad Query Console</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="bareclad.css" />
</head>
<body>
<!-- Prism.js for syntax highlighting (works with file:// protocol) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<header>
  <img class="svg" src="Traqula.svg"/>
  Bareclad Query Console
</header>
<main>
  <div id="splitContainer">
    <div id="editorPane">
      <section>
        <label for="endpoint">Endpoint</label>
        <input id="endpoint" type="text" value="http://127.0.0.1:8080/v1/query" />
        <label for="script">Traqula Script (Ctrl+Enter to run)</label>
        <div id="script-container">
          <textarea id="script" spellcheck="false"></textarea>
          <pre id="script-highlight"><code class="language-traqula">
search +posit [{(+person, name)}, +name, +since]
return
    posit, person, name, since;
          </code></pre>
        </div>
        <div class="controls">
          <button id="runBtn">Run</button>
          <button id="clearBtn" title="Clear results">Clear</button>
          <label>Timeout <input type="number" id="timeout" min="0" step="100" placeholder="ms"></label>
          <label><input type="checkbox" id="autoScroll" checked> Auto-scroll to latest</label>
        </div>
        <div id="statusBar"></div>
        <progress id="progress" max="100" value="0"></progress>
      </section>
    </div>
    <div id="splitter" title="Drag to resize"></div>
    <div id="resultsPane">
      <div id="resultsTabs">
        <button class="tabBtn active" data-tab="table">Table</button>
        <button class="tabBtn" data-tab="json">JSON</button>
        <button class="tabBtn" data-tab="status">Status</button>
        <select id="resultSetSelect" style="display:none;" title="Select result set"></select>
        <div></div>
        <span id="perf"></span>
      </div>
      <div id="tableView">
        <table id="resultsTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="jsonView">
        <pre id="jsonOut"></pre>
      </div>
      <div id="statusView">
        <pre id="statusOut"></pre>
      </div>
    </div>
  </div>
</main>
<footer>
  <span>Bareclad local console (dev)</span>
  <span>Drag splitter to resize editor/results • Tabs to switch view • Status tab shows logs</span>
</footer>
<script>
const els = {
  endpoint: document.getElementById('endpoint'),
  script: document.getElementById('script'),
  runBtn: document.getElementById('runBtn'),
  clearBtn: document.getElementById('clearBtn'),
  tableHead: document.querySelector('#resultsTable thead'),
  tableBody: document.querySelector('#resultsTable tbody'),
  status: document.getElementById('statusBar'),
  jsonOut: document.getElementById('jsonOut'),
  autoScroll: document.getElementById('autoScroll'),
  timeout: document.getElementById('timeout'),
  perf: document.getElementById('perf'),
  progress: document.getElementById('progress'),
  splitter: document.getElementById('splitter'),
  editorPane: document.getElementById('editorPane'),
  resultsPane: document.getElementById('resultsPane'),
  tabs: document.querySelectorAll('.tabBtn'),
  tableView: document.getElementById('tableView'),
  jsonView: document.getElementById('jsonView'),
  statusView: document.getElementById('statusView'),
  statusOut: document.getElementById('statusOut'),
  resultSetSelect: document.getElementById('resultSetSelect')
};
let lastResponse = null;

// Load saved query from localStorage
const savedQuery = localStorage.getItem('bareclad-query');
if (savedQuery) {
  els.script.value = savedQuery;
}

// Define Traqula language for Prism.js
Prism.languages.traqula = {
  'comment': /\/\*[\s\S]*?\*\//,
  'keyword': /\b(?:add|role|posit|search|return|where|and|limit|as|of)\b/i,
  'constant': /@[A-Z]+/,
  'time': /'[0-9:\-\s]+'/,
  'string': /"(?:[^"\\]|\\.)*"/,
  'number': /-?\d+(?:\.\d+)?%?/,
  'variable-insert': /\+[a-zA-Z][a-zA-Z0-9_]*/,
  'variable': /\b[a-zA-Z][a-zA-Z0-9_]*\b/,
  'operator': /[+|<>=!]+/,
  'wildcard': /\*/,
  'punctuation': /[[\]{}(),;]/
};

// Get DOM elements  
const scriptTextarea = document.getElementById('script');
const scriptHighlight = document.getElementById('script-highlight');

// Function to update syntax highlighting
function updateHighlight() {
  const code = scriptTextarea.value;
  const highlightedCode = Prism.highlight(code, Prism.languages.traqula, 'traqula');
  scriptHighlight.querySelector('code').innerHTML = highlightedCode;
  
  // Save query to localStorage
  localStorage.setItem('bareclad-query', code);
}

// Sync scroll between textarea and highlight
function syncScroll() {
  scriptHighlight.scrollTop = scriptTextarea.scrollTop;
  scriptHighlight.scrollLeft = scriptTextarea.scrollLeft;
}

// Setup event listeners for the editor
scriptTextarea.addEventListener('input', updateHighlight);
scriptTextarea.addEventListener('scroll', syncScroll);
scriptTextarea.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
    runQuery();
  }
  
  // Handle tab key for indentation
  if (e.key === 'Tab') {
    e.preventDefault();
    const start = this.selectionStart;
    const end = this.selectionEnd;
    const value = this.value;
    this.value = value.substring(0, start) + '    ' + value.substring(end);
    this.selectionStart = this.selectionEnd = start + 4;
    updateHighlight();
  }
});

// Initialize highlighting
setTimeout(() => {
  updateHighlight();
  setStatus('Editor loaded with syntax highlighting');
  
  // Initialize status view with welcome message
  const initTime = new Date().toLocaleTimeString();
  els.statusOut.textContent = `[${initTime}] Bareclad Query Console initialized\n[${initTime}] Editor loaded with syntax highlighting\n`;
}, 100);

// Save query on page unload
window.addEventListener('beforeunload', () => {
  localStorage.setItem('bareclad-query', scriptTextarea.value);
});

// No Monaco initialization needed - using Prism.js instead
function setStatus(msg, cls='') {
  // Update the status bar with brief messages only
  if (cls === 'err') {
    // For errors, show a brief indicator in status bar
    els.status.textContent = 'Error occurred - see Status tab for details';
    els.status.className = cls;
  } else {
    // For non-errors, show the full message
    els.status.textContent = msg;
    els.status.className = cls;
  }

  // Always log to status view with timestamp
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = `[${timestamp}] ${msg}\n`;
  els.statusOut.textContent += logEntry;

  // Auto-scroll to bottom of status view
  const statusView = els.statusView;
  setTimeout(() => {
    statusView.scrollTop = statusView.scrollHeight;
  }, 0);

  // Switch to status tab if there's an error
  if (cls === 'err') {
    els.tabs.forEach(btn => btn.classList.remove('active'));
    const statusTab = document.querySelector('[data-tab="status"]');
    if (statusTab) {
      statusTab.classList.add('active');
      els.tableView.style.display = 'none';
      els.jsonView.style.display = 'none';
      els.statusView.style.display = 'block';
    }
  }
  // Switch back to table tab for successful query completion
  else if (msg === 'OK') {
    els.tabs.forEach(btn => btn.classList.remove('active'));
    const tableTab = document.querySelector('[data-tab="table"]');
    if (tableTab) {
      tableTab.classList.add('active');
      els.tableView.style.display = 'block';
      els.jsonView.style.display = 'none';
      els.statusView.style.display = 'none';
    }
  }
}
function escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
function buildTable(columns, rows, rowTypes) {
  els.tableHead.innerHTML = '';
  els.tableBody.innerHTML = '';
  if (!columns || columns.length===0) return;
  // Collect unique data types for each column
  const columnTypes = columns.map((_, colIndex) => {
    const types = new Set();
    if (rowTypes) {
      rowTypes.forEach(rowType => {
        if (rowType && rowType[colIndex]) {
          types.add(rowType[colIndex]);
        }
      });
    }
    return Array.from(types).sort();
  });
  const tr = document.createElement('tr');
  columns.forEach((c,i)=>{
    const th = document.createElement('th');
    th.innerHTML = escapeHtml(c) + '<br><span>'+ escapeHtml(columnTypes[i].join(', ') || '') +'</span>';
    tr.appendChild(th);
  });
  els.tableHead.appendChild(tr);
  rows.forEach((r,ri)=>{
    const tr = document.createElement('tr');
    r.forEach((cell,ci)=>{
      const td = document.createElement('td');
      const typ = (rowTypes && rowTypes[ri] ? rowTypes[ri][ci] : '');
      let display = String(cell);
      if (typ === 'Certainty') {
        display = formatCertaintyDisplay(display);
      }
      td.innerHTML = '<span class="badge '+escapeHtml(typ)+'">'+escapeHtml(typ||'')+'</span> '+ escapeHtml(display);
      tr.appendChild(td);
    });
    els.tableBody.appendChild(tr);
    if (els.autoScroll.checked) tr.scrollIntoView({block:'end'});
  });
}

function populateResultSetSelect(resultSets) {
  const sel = els.resultSetSelect;
  if (!resultSets || resultSets.length <= 1) {
    sel.style.display = 'none';
    sel.innerHTML = '';
    return;
  }
  sel.style.display = 'inline-block';
  sel.innerHTML = '';
  resultSets.forEach((rs, idx) => {
    const opt = document.createElement('option');
    const colPreview = rs.columns.slice(0,4).join(', ');
    opt.value = idx;
    opt.textContent = `Set ${idx+1} (${rs.row_count} rows)`;
    opt.title = `Columns: ${colPreview}${rs.columns.length>4?'…':''}`;
    sel.appendChild(opt);
  });
}
async function runQuery() {
  const endpoint = els.endpoint.value.trim();
  const script = scriptTextarea.value;
  const payload = { script: script, stream: false };
  const timeoutMs = parseInt(els.timeout.value || '0',10);
  els.runBtn.disabled = true; setStatus('Running...'); els.progress.style.visibility='visible'; els.progress.value=15;
  const controller = timeoutMs>0 ? new AbortController() : null;
  if (controller) setTimeout(()=>controller.abort(), timeoutMs);
  const started = performance.now();
  try {
    const res = await fetch(endpoint, {
      method:'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(payload),
      signal: controller? controller.signal : undefined
    });
    els.progress.value=60;
    const json = await res.json();
    lastResponse = json;
    els.progress.value=85;
    if (json.status === 'ok') {
      if (json.result_sets) {
        populateResultSetSelect(json.result_sets);
        // Default to first set
        const first = json.result_sets[0];
        buildTable(first.columns, first.rows||[], first.row_types||[]);
        els.resultSetSelect.onchange = () => {
          const idx = parseInt(els.resultSetSelect.value,10);
            const rs = json.result_sets[idx];
            buildTable(rs.columns, rs.rows||[], rs.row_types||[]);
        };
      } else {
        populateResultSetSelect(null);
        buildTable(json.columns, json.rows||[], json.row_types||[]);
      }
      const ms = (performance.now()-started).toFixed(2);
      els.perf.textContent = `client ${(ms)} ms | server ${(json.elapsed_ms).toFixed(3)} ms | rows ${json.row_count}`;
      setStatus('OK');
    } else {
      buildTable([],[],[]);
      setStatus('Error: '+ json.error, 'err');
    }
    els.jsonOut.textContent = JSON.stringify(json, null, 2);
  } catch (e) {
    setStatus('Request failed: '+ e.message, 'err');
  } finally {
    els.runBtn.disabled=false; els.progress.value=100; setTimeout(()=>{els.progress.style.visibility='hidden';},400);
  }
}
els.runBtn.addEventListener('click', runQuery);
els.clearBtn.addEventListener('click', ()=>{ 
  els.tableHead.innerHTML=''; 
  els.tableBody.innerHTML=''; 
  els.jsonOut.textContent=''; 
  els.statusOut.textContent=''; 
  els.perf.textContent=''; 
  setStatus('Cleared'); 
});

// Tabs switching
els.tabs.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    els.tabs.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.getAttribute('data-tab');
    if (tab==='table') { 
      els.tableView.style.display='block'; 
      els.jsonView.style.display='none'; 
      els.statusView.style.display='none'; 
    }
    else if (tab==='json') { 
      els.tableView.style.display='none'; 
      els.jsonView.style.display='block'; 
      els.statusView.style.display='none'; 
    }
    else if (tab==='status') { 
      els.tableView.style.display='none'; 
      els.jsonView.style.display='none'; 
      els.statusView.style.display='block'; 
    }
  });
});

// Vertical splitter drag logic
let dragging = false; let startY = 0; let startHeight = 0;
function setEditorHeight(px){
  const min = 100; const max = window.innerHeight * 0.85;
  const clamped = Math.min(Math.max(px,min), max);
  els.editorPane.style.flex = '0 0 '+clamped+'px';
}
els.splitter.addEventListener('mousedown', e=>{
  dragging = true; startY = e.clientY; startHeight = els.editorPane.getBoundingClientRect().height;
  document.body.style.cursor='row-resize';
  e.preventDefault();
});
window.addEventListener('mousemove', e=>{
  if (!dragging) return; const dy = e.clientY - startY; setEditorHeight(startHeight + dy);
});
window.addEventListener('mouseup', ()=>{ if (dragging) { dragging=false; document.body.style.cursor=''; }});
window.addEventListener('resize', ()=>{ /* keep within bounds */ setEditorHeight(els.editorPane.getBoundingClientRect().height); });

function formatCertaintyDisplay(raw) {
  if (raw === undefined || raw === null) return raw;
  if (raw === '?') return raw;
  // Expect forms: -1, -0.xx, 0, 0.xx, 1
  if (raw === '1' || raw === '-1') return (raw.startsWith('-')?'-':'') + '100%';
  if (raw === '0') return '0%';
  const m = raw.match(/^(-?)0\.(\d{1,2})$/);
  if (m) {
    const sign = m[1];
    const digits = m[2];
    // strip potential leading zero in percent, keep as integer ("05" -> 5) but preserve up to 2 digits
    const pct = parseInt(digits,10); // safe
    return sign + pct + '%';
  }
  return raw; // fallback
}
</script>
</body>
</html>
